---
- name: Multi-Subnet IPAM + GCP Provisioning
  hosts: 192.168.116.129
  gather_facts: no
  connection: ssh

  vars_files:
    - vars/common.yml
    - vars/paths.yml

  vars:
    region_map:
      AO: asia-south1
      EU: europe-west1
      AS: asia-east1
      NA: us-central1

  tasks:

    # ----------------------------------------------------------
    # 0. Validation
    # ----------------------------------------------------------
    - fail:
        msg: "'subnets' variable missing"
      when: subnets is not defined

    - fail:
        msg: "'subnets' should be a list"
      when: subnets is not iterable

    - fail:
        msg: "Max 5 subnets per execution allowed"
      when: subnets | length > 5


    # ----------------------------------------------------------
    # 1. Initialize Report List
    # ----------------------------------------------------------
    - name: Init subnet_report
      set_fact:
        subnet_report: []
      delegate_to: localhost


    # ----------------------------------------------------------
    # 2. Load CSV files
    # ----------------------------------------------------------
    - name: Read Env.csv
      read_csv:
        path: "{{ env_csv }}"
      register: env_raw

    - set_fact:
        env_data: "{{ env_raw.list }}"

    - name: Read Subnet.csv
      read_csv:
        path: "{{ subnet_csv }}"
      register: subnet_raw
      ignore_errors: yes   # CSV may be empty first time

    - set_fact:
        subnet_data: "{{ subnet_raw.list | default([]) }}"


    # ----------------------------------------------------------
    # 3. Process each subnet request
    # ----------------------------------------------------------
    - name: Process each subnet request
      include_tasks: subnet_unit.yml
      loop: "{{ subnets }}"
      loop_control:
        loop_var: req
        index_var: batch_index
      vars:
        naming_region: "{{ req.RegionCode | lower }}"
        naming_env: "{{ req.Env | lower }}"
        naming_solution: "{{ req.Solution | lower }}"
        naming_gcp_region: "{{ region_map[req.RegionCode] }}"


    # ----------------------------------------------------------
    # 4. Determine overall job status
    # ----------------------------------------------------------
    - name: Determine overall status
      set_fact:
        overall_status: >-
          {% if (subnet_report | selectattr('status','equalto','FAILED') | list) | length > 0 %}
            FAILED
          {% else %}
            SUCCESS
          {% endif %}
      delegate_to: localhost
      run_once: true


    # ----------------------------------------------------------
    # 5. Generate HTML report
    # ----------------------------------------------------------
    - name: Render HTML email report
      template:
        src: "templates/subnet_report.html.j2"
        dest: "/tmp/subnet_report.html"
      delegate_to: localhost
      run_once: true


    # ----------------------------------------------------------
    # 6. Send Email (Status-aware)
    # ----------------------------------------------------------
    - name: Send HTML email
      mail:
        host: smtp.gmail.com
        port: 587
        username: "{{ email_user }}"
        password: "{{ email_password }}"
        to: "{{ email_to }}"
        subject: "GCP Subnet Provisioning Report - {{ overall_status }}"
        subtype: html
        body: "{{ lookup('file','/tmp/subnet_report.html') }}"
      delegate_to: localhost
      run_once: true
